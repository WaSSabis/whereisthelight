<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Где свет? — Москва</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      overflow: hidden;
    }

    /* === ЗАТЕМНЕНИЕ КАРТЫ === */
    #map {
      height: 100vh;
      filter: brightness(0.65) contrast(1.15) saturate(0.9);
    }

    /* === ЛОББИ === */
    #lobby {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      text-align: center;
      padding: 20px;
    }
    #lobby h1 {
      font-size: 2.6rem;
      margin-bottom: 24px;
      color: #ff4444;
      text-shadow: 0 0 12px rgba(255, 68, 68, 0.7);
      opacity: 0;
      animation: fadeIn 1s forwards;
    }
    #lobby-desc {
      max-width: 520px;
      margin-bottom: 32px;
      line-height: 1.6;
      opacity: 0;
      animation: fadeIn 1s forwards 0.4s;
    }
    #phone-form {
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.6s forwards 0.8s;
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #phone-input {
      width: 100%;
      padding: 14px;
      font-size: 18px;
      background: #1a1a1a;
      border: 1px solid #444;
      color: white;
      text-align: center;
      border-radius: 8px;
      outline: none;
    }
    #candle-btn {
      background: #aa3300;
      color: white;
      border: none;
      padding: 14px;
      font: bold 1.2rem 'Courier New', monospace;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #candle-btn:hover {
      background: #cc5500;
      box-shadow: 0 0 15px rgba(255, 100, 0, 0.5);
    }
    #lobby-footer {
      position: absolute;
      bottom: 24px;
      font-size: 13px;
      opacity: 0.6;
      animation: fadeIn 1s forwards 1.4s;
    }

    /* === ЭКРАН СО СВЕЧОЙ === */
    #candle-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }
    .candle-big {
      position: relative;
      width: 28px;
      height: 60px;
      background: #ffcc88;
      border-radius: 5px;
      margin-bottom: 30px;
      box-shadow: 0 0 25px #ffaa55;
    }
    .candle-big::before {
      content: '';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 14px;
      height: 14px;
      background: #ff5500;
      border-radius: 50%;
      animation: flicker 1.5s infinite alternate;
    }
    @keyframes flicker {
      0%, 100% { opacity: 1; box-shadow: 0 0 25px #ffaa00, 0 0 50px #ff6600; }
      50% { opacity: 0.85; box-shadow: 0 0 20px #ff9900, 0 0 40px #ff5500; }
    }
    #candle-text {
      font-size: 1.4rem;
      text-align: center;
      max-width: 80%;
      opacity: 0.95;
      line-height: 1.5;
    }

    /* === ПОДТВЕРЖДЕНИЕ === */
    #confirm-modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.88);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
      padding: 20px;
      text-align: center;
    }
    #confirm-modal h3 {
      margin-bottom: 20px;


color: #ffaa55;
      font-size: 1.5rem;
    }
    .confirm-btns {
      display: flex;
      gap: 24px;
    }
    .confirm-btn {
      padding: 12px 28px;
      font: bold 1.1rem 'Courier New';
      border: none;
      border-radius: 8px;
      cursor: pointer;
      min-width: 120px;
    }
    #confirm-yes { background: #d00; color: white; }
    #confirm-no { background: #333; color: #ccc; }

    /* === ИНФО-ПАНЕЛЬ (СЛЕВА СВЕРХУ) === */
    .info-panel {
      position: fixed;
      top: 16px;
      left: 16px;
      background: rgba(10, 10, 10, 0.88);
      border: 1px solid #333;
      border-radius: 14px;
      padding: 14px;
      font-size: 13px;
      z-index: 1000;
      max-width: 240px;
    }
    .info-panel h3 {
      margin-bottom: 10px;
      color: #ff6666;
      font-size: 14px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .clear-all-btn {
      width: 100%;
      background: #2a1a1a;
      color: #ff6666;
      border: 1px solid #444;
      padding: 6px;
      border-radius: 6px;
      font-family: 'Courier New';
      font-size: 12px;
      cursor: pointer;
      margin-top: 8px;
    }
    .clear-all-btn:hover { background: #3a2020; }

    /* === ПАНЕЛЬ ИНСТРУМЕНТОВ (СПРАВА СВЕРХУ) === */
    .toolbar {
      position: fixed;
      top: 16px;
      right: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      z-index: 1000;
    }
    .tool-btn {
      width: 52px;
      height: 52px;
      background: rgba(20, 20, 20, 0.85);
      border: 1px solid #444;
      color: #ddd;
      font-size: 18px;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .tool-btn:hover { background: #333; }
    .tool-btn.active {
      background: #ff3333;
      color: white;
      border-color: #ff5555;
      box-shadow: 0 0 10px rgba(255, 50, 50, 0.5);
    }
    .tool-label {
      font-size: 10px;
      margin-top: 4px;
      opacity: 0.7;
    }

    /* === ЛЕГЕНДА (СЛЕВА СНИЗУ) === */
    .legend {
      position: fixed;
      bottom: 20px;
      left: 16px;
      background: rgba(10, 10, 10, 0.85);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      z-index: 999;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 8px;
    }
    .rect-color { background: rgba(255, 50, 50, 0.3); border: 1px solid #f55; }
    .circle-color { background: #ff5555; }
    .candle-color { background: #ffcc88; }

    /* === ПОДСКАЗКА (СНИЗУ ПО ЦЕНТРУ) === */
    .hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      padding: 7px 18px;
      border-radius: 24px;
      font-size: 14px;
      opacity: 0.85;
      z-index: 999;
    }

    /* === ЧАТ === */
    #chat-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      background: rgba(10, 10, 10, 0.92);
      border: 1px solid #333;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      z-index: 2000;
    }
    #chat-messages {
      height: 120px;
      padding: 10px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.4;
    }
    #chat-input-line {
      display: flex;
      padding: 6px;
      border-top: 1px solid #333;
    }
    #chat-input {
      flex: 1;
      background: #222;
      border: 1px solid #444;
      color: white;
      padding: 6px 8px;
      font-family: 'Courier New', monospace;

font-size: 13px;
    }
    #chat-send {
      background: #333;
      color: #aaa;
      border: 1px solid #444;
      padding: 6px 10px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    #chat-send:hover { background: #444; color: #fff; }
    .chat-msg { margin-bottom: 6px; word-wrap: break-word; }
    .chat-msg.me { color: #ffaa55; }
    .chat-msg.other { color: #888; }

    /* === АНИМАЦИИ === */
    @keyframes fadeIn { to { opacity: 1; } }
    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .leaflet-control-attribution { display: none !important; }
  </style>
</head>
<body>

<!-- ЛОББИ -->
<div id="lobby">
  <h1>ГДЕ СВЕТ?</h1>
  <div id="lobby-desc">
    Отмечайте районы, где пропало электричество в Москве. Введите номер — и зажгите свою свечу.
  </div>
  <div id="phone-form">
    <input type="text" id="phone-input" placeholder="+7 _ _--" maxlength="18" />
    <button id="candle-btn">Зажечь свечу</button>
  </div>
  <div id="lobby-footer">Данные не уходят в сеть. Всё хранится только у вас.</div>
</div>

<!-- СВЕЧА -->
<div id="candle-screen">
  <div class="candle-big"></div>
  <div id="candle-text">Ваша свеча зажжена.<br>Вы не одни в темноте.</div>
</div>

<!-- ПОДТВЕРЖДЕНИЕ -->
<div id="confirm-modal">
  <h3>Подтвердите действие</h3>
  <p>В выделенном районе отсутствует электричество?</p>
  <div class="confirm-btns">
    <button class="confirm-btn" id="confirm-no">Отмена</button>
    <button class="confirm-btn" id="confirm-yes">Подтвердить</button>
  </div>
</div>

<!-- КАРТА -->
<div id="map"></div>

<!-- ИНФО-ПАНЕЛЬ -->
<div class="info-panel">
  <h3>Москва · Статус</h3>
  <div class="info-row">
    <span>Время:</span>
    <span id="current-time">--:--</span>
  </div>
  <div class="info-row">
    <span>Зон без света:</span>
    <span id="zones-count">0</span>
  </div>
  <button class="clear-all-btn" id="clear-all">Очистить все отметки</button>
</div>

<!-- ПАНЕЛЬ ИНСТРУМЕНТОВ -->
<div class="toolbar">
  <div class="tool-btn active" id="tool-rect" title="Выделить район">
    <div>◩</div>
    <div class="tool-label">Район</div>
  </div>
  <div class="tool-btn" id="tool-point" title="Отметить здание">
    <div>●</div>
    <div class="tool-label">Точка</div>
  </div>
  <div class="tool-btn" id="tool-eraser" title="Удалить">
    <div>⌫</div>
    <div class="tool-label">Ластик</div>
  </div>
  <div class="tool-btn" id="tool-undo" title="Отменить">
    <div>↶</div>
    <div class="tool-label">Отмена</div>
  </div>
</div>

<!-- ЛЕГЕНДА -->
<div class="legend">
  <div class="legend-item">
    <div class="legend-color rect-color"></div>
    <span>Район без света</span>
  </div>
  <div class="legend-item">
    <div class="legend-color circle-color"></div>
    <span>Отдельное здание</span>
  </div>
</div>

<!-- ПОДСКАЗКА -->
<div class="hint" id="hint">Выделите участок: зажмите и потяните</div>

<!-- ЧАТ -->
<div id="chat-box">
  <div id="chat-messages"></div>
  <div id="chat-input-line">
    <input type="text" id="chat-input" placeholder="Сообщение..." maxlength="100" />
    <button id="chat-send">→</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const TTL = 3 * 60 * 60 * 1000;
  const STORAGE_KEY = 'moscow_outages_pro';

  let outages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  let markers = [];
  let map = null;
  let currentTool = 'rect';
  let dragStart = null;
  let tempRect = null;
  let isDragging = false;
  let pendingRect = null;
  let pendingPoint = null;
  const history = [];

  const MKAD_BOUNDS = [[55.566, 37.343], [55.922, 37.945]];

  // === Время ===
  function updateTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = 
      now.getHours().toString().padStart(2, '0') + ':' + 
      now.getMinutes().toString().padStart(2, '0');
  }
  setInterval(updateTime, 1000);
  updateTime();

// === Формат телефона ===
  document.getElementById('phone-input').addEventListener('input', function(e) {
    let val = e.target.value.replace(/\D/g, '');
    if (val.startsWith('8')) val = '7' + val.slice(1);
    if (val.length === 0) {
      e.target.value = '';
    } else if (val.length <= 1) {
      e.target.value = '+7';
    } else if (val.length <= 4) {
      e.target.value = '+7 (' + val.slice(1);
    } else if (val.length <= 7) {
      e.target.value = '+7 (' + val.slice(1, 4) + ') ' + val.slice(4);
    } else if (val.length <= 9) {
      e.target.value = '+7 (' + val.slice(1, 4) + ') ' + val.slice(4, 7) + '-' + val.slice(7);
    } else {
      e.target.value = '+7 (' + val.slice(1, 4) + ') ' + val.slice(4, 7) + '-' + val.slice(7, 9) + '-' + val.slice(9, 11);
    }
  });

  // === РЕГИСТРАЦИЯ → СВЕЧА → КАРТА ===
  document.getElementById('candle-btn').onclick = () => {
    const phone = document.getElementById('phone-input').value.trim().replace(/\D/g, '');
    if (phone.length < 6) {
      alert('Пожалуйста, введите номер (можно любой)');
      return;
    }
    localStorage.setItem('user_registered', 'true');
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('candle-screen').style.display = 'flex';
    setTimeout(() => {
      document.getElementById('candle-screen').style.display = 'none';
      initMap();
    }, 1800);
  };

  // === ЧАТ ===
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  chatSend.onclick = () => sendChat();
  chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };
  function sendChat() {
    const t = chatInput.value.trim();
    if (!t) return;
    const el = document.createElement('div');
    el.className = 'chat-msg me';
    el.textContent = t;
    document.getElementById('chat-messages').appendChild(el);
    document.getElementById('chat-messages').scrollTop = 1e10;
    chatInput.value = '';
  }

  // === Подтверждение ===
  function showConfirm(data) {
    pendingRect = data;
    document.getElementById('confirm-modal').style.display = 'flex';
  }

  document.getElementById('confirm-yes').onclick = () => {
    if (pendingRect) {
      history.push({ action: 'add',  pendingRect });
      outages.push(pendingRect);
      save();
      pendingRect = null;
    }
    document.getElementById('confirm-modal').style.display = 'none';
  };
  document.getElementById('confirm-no').onclick = () => {
    pendingRect = null;
    document.getElementById('confirm-modal').style.display = 'none';
  };

  // === Очистка ===
  function cleanup() {
    const now = Date.now();
    outages = outages.filter(item => (now - item.ts) < TTL);
    save();
  }
  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(outages));
    render();
  }

  // === КАРТА ===
  function initMap() {
    const kremlin = [55.751244, 37.618423];
    map = L.map('map', {
      minZoom: 10,
      maxZoom: 16,
      maxBounds: MKAD_BOUNDS,
      maxBoundsViscosity: 1.0
    }).setView(kremlin, 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    cleanup();
    render();
    setupTools();
    setupMapEvents();
  }

  function render() {
    if (!map) return;
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const now = Date.now();
    let count = 0;
    outages.forEach(item => {
      if (now - item.ts >= TTL) return;
      let shape;
      if (item.type === 'rect') {
        shape = L.rectangle([[item.lat, item.lng], [item.lat2, item.lng2]], {
          color: '#ff3333',
          fillOpacity: 0.25,
          weight: 2
        });
      } else if (item.type === 'point') {
        shape = L.circleMarker([item.lat, item.lng], {
          radius: 7,
          color: '#ff3333',
          fillColor: '#ff5555',
          fillOpacity: 0.9,
          weight: 1
        });
      }
      if (shape) {
        shape.addTo(map);
        markers.push(shape);
        count++;
      }
    });

document.getElementById('zones-count').textContent = count;
  }

  function setupTools() {
    const setActive = (tool) => {
      currentTool = tool;
      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tool-${tool}`).classList.add('active');

      const hint = document.getElementById('hint');
      if (tool === 'rect') {
        hint.textContent = 'Выделите район: зажмите и потяните';
      } else if (tool === 'point') {
        hint.textContent = 'Кликните на здание, чтобы отметить';
      } else if (tool === 'eraser') {
        hint.textContent = 'Кликните на отметку, чтобы удалить';
      } else {
        hint.textContent = '';
      }
    };

    document.getElementById('tool-rect').onclick = () => setActive('rect');
    document.getElementById('tool-point').onclick = () => setActive('point');
    document.getElementById('tool-eraser').onclick = () => setActive('eraser');
    document.getElementById('tool-undo').onclick = undoLastAction;
    document.getElementById('clear-all').onclick = () => {
      if (outages.length && confirm('Очистить все отметки?')) {
        outages = [];
        history.length = 0;
        save();
      }
    };
  }

  function setupMapEvents() {
    if (!map) return;

    map.on('mousedown', (e) => {
      if (currentTool !== 'rect') return;
      isDragging = true;
      dragStart = e.latlng;
      tempRect = null;
      map.dragging.disable();
    });

    map.on('mousemove', (e) => {
      if (!isDragging || !dragStart) return;
      if (tempRect) map.removeLayer(tempRect);
      tempRect = L.rectangle([dragStart, e.latlng], {
        color: '#ffaa00',
        fillOpacity: 0.15,
        dashArray: '4, 4'
      }).addTo(map);
    });

    map.on('mouseup', () => {
      if (!isDragging) return;
      isDragging = false;
      if (tempRect) {
        const bounds = tempRect.getBounds();
        map.removeLayer(tempRect);
        showConfirm({
          type: 'rect',
          lat: bounds.getSouthWest().lat,
          lng: bounds.getSouthWest().lng,
          lat2: bounds.getNorthEast().lat,
          lng2: bounds.getNorthEast().lng,
          ts: Date.now()
        });
      }
      map.dragging.enable();
      tempRect = null;
      dragStart = null;
    });

    map.on('click', (e) => {
      if (currentTool === 'point') {
        showConfirm({
          type: 'point',
          lat: e.latlng.lat,
          lng: e.latlng.lng,
          ts: Date.now()
        });
      } else if (currentTool === 'eraser') {
        const click = e.latlng;
        let foundIndex = -1;
        for (let i = outages.length - 1; i >= 0; i--) {
          const item = outages[i];
          if (Date.now() - item.ts >= TTL) continue;
          let inside = false;
          if (item.type === 'rect') {
            inside = (
              click.lat >= item.lat && click.lat <= item.lat2 &&
              click.lng >= item.lng && click.lng <= item.lng2
            );
          } else if (item.type === 'point') {
            const dist = map.distance([item.lat, item.lng], [click.lat, click.lng]);
            inside = dist < 60;
          }
          if (inside) { foundIndex = i; break; }
        }
        if (foundIndex >= 0) {
          const removed = outages.splice(foundIndex, 1)[0];
          history.push({ action: 'remove',  removed });
          save();
        }
      }
    });
  }

  function undoLastAction() {
    if (history.length === 0) return;
    const last = history.pop();
    if (last.action === 'add') {
      outages = outages.filter(item => JSON.stringify(item) !== JSON.stringify(last.data));
    } else if (last.action === 'remove') {
      outages.push(last.data);
    }
    save();
  }

  setInterval(cleanup, 60000);
</script>
</body>
</html>
